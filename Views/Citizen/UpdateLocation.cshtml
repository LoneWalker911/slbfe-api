
@{
    ViewBag.Title = "UpdateLocation";
    Layout = "~/Views/Shared/_CitizenLayout.cshtml";
}
<div id="divLocationUpdate" class="justify-content-center" v-cloak>
    <div class="jumbotron">
        <div class="card-body ">
            <form id="frmLocationUpdate">
                <h3>Update Citizen Location</h3>
                <div class="col-12 float-start px-0 px-md-1">
                    <div class="form-field mb-2">
                        <button style="float:right" type="button" class="btn btn-outline-success" title="update Location" @@click="updateLocation">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload" viewBox="0 0 16 16">
                                <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z" />
                                <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z" />
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="form-row">
                    <div class="col-12 float-start px-0 px-md-1">
                        <label class="form-label">Select Your Location</label>
                        <div id="map" style="width:100%;height:400px;"></div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        var markers = [];

        function clearMarkers() {
            for (var i = 0; i < markers.length; i++) {
                markers[i].setMap(null);
            }
            markers.length = 0;
        }
         Vue.config.devtools = true;

          if (vueLocationUpdate != null) {
              vueLocationUpdate.$destroy();
          }


        var vueLocationUpdate = new Vue({
            el: '#divLocationUpdate',
        data: {
            editCitizenNic: { nic: 200032201860 },
            editCitizen: { Q: '' },
            map: null,



        },
        methods: {
            getCitizenDetail() {
                $.ajax({
                    url: 'https://edu.santhawa.lk/apiv1/citizen/id/' + String(getCookie('userId')),
                    type: 'GET',
                    contentType: 'application/json',
                    success: function (data, status, response) {
                        console.log(data);
                        clearMarkers();
                        vueLocationUpdate.editCitizen = JSON.parse(response.responseText);
                        var myLatlng = new google.maps.LatLng((vueLocationUpdate.editCitizen.latitude), (vueLocationUpdate.editCitizen.longitude))
                        var marker = new google.maps.Marker({ position: myLatlng, title: "Citizen's Location", });
                        markers.push(marker);
                        marker.setMap(vueLocationUpdate.map);
                        vueLocationUpdate.map.panTo(myLatlng);

                    },
                });
            },
            initMap() {
                const defLatLng = { lat: 25.363, lng: 131.044 };
                this.map = new google.maps.Map(document.getElementById("map"), {
                    zoom: 4,
                    center: defLatLng,
                });

                this.map.addListener("click", (mapsMouseEvent) => {


                    this.location = mapsMouseEvent.latLng.toJSON();
                    vueLocationUpdate.editCitizen.latitude = this.location.lat.toFixed(6);
                    vueLocationUpdate.editCitizen.longitude = this.location.lng.toFixed(6);

                    clearMarkers();
                    var myLatlng = new google.maps.LatLng((vueLocationUpdate.editCitizen.latitude), (vueLocationUpdate.editCitizen.longitude))
                    var marker = new google.maps.Marker({ position: myLatlng, title: "Citizen's Location", });
                    markers.push(marker);
                    marker.setMap(vueLocationUpdate.map);
                    vueLocationUpdate.map.panTo(myLatlng);


                });
            },
            updateLocation() {
                var url = "https://edu.santhawa.lk/apiv1/citizen/" + String(this.editCitizen.id);

                var xhr = new XMLHttpRequest();
                xhr.open("PUT", url);

                xhr.setRequestHeader("Authorization", getCookie('token'));

                xhr.onreadystatechange = function () {
                    if (xhr.readyState === 4) {
                        console.log(xhr.status);
                        console.log(xhr.responseText);
                    }
                };

                xhr.send(JSON.stringify(vueLocationUpdate.editCitizen));
            },
            sendHeaders() {
                $.ajaxSetup({
                    headers: {
                        'Authorization': getCookie('token')
                    }
                });
            }



        },
        computed: {
        },
            mounted() {
                this.sendHeaders();
            window.initMap = this.initMap;
                this.getCitizenDetail();

            },
    });
    </script>
}





